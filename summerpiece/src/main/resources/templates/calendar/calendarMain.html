<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/fragments/header.html :: header"/>
<link href='/lib/fullcalendar/main.css' rel='stylesheet' />
<script src="/lib/fullcalendar/main.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let calendarEl = document.getElementById('calendar');
    let draggedEventIsAllDay ;

    let calendar = new FullCalendar.Calendar(calendarEl, {
      customButtons: {
        addSchedule: {
          text: '일정 등록',
          click: function(event) {
            location.href = "/calendar/schedule/one";
          }
        }
      },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay addSchedule'
      },
      allDaySlot: true,
      initialDate: new Date(),
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectMirror: true,
      locale: 'ko',
      timeFormat: 'HH:mm',
      views: {
        month: {eventLimit : 5}
      },
      select: function(arg) {
        let calendarStart = moment(arg.start).format('YYYY-MM-DD');
        let calendarEnd = moment(arg.end).subtract(1, 'days').format('YYYY-MM-DD');

        if(calendarStart == calendarEnd){
          location.href = "/calendar/schedule/one/" + calendarStart;

        } else{
          let calendarContent = prompt('일정 내용을 입력하세요.');
          if (calendarContent) {
            let isAllDay = arg.allDay;

            // calendarEnd = moment(arg.end).add(1, 'days').format('YYYY-MM-DD');

            let data = {
              "calendarContent":calendarContent,
              "calendarStart":calendarStart,
              "calendarEnd":calendarEnd,
              "isAllDay":isAllDay,
              "calendarColor":"#A0A0A0FF"
            }

            $.ajax({
              url: '/calendar/schedule',
              method: 'POST',
              data: data,
              dataType: 'text',
              success: function(data){
                calendar.addEvent({
                  title: calendarContent,
                  start: calendarStart,
                  end: calendarEnd,
                  allDay: isAllDay,
                  color: "#A0A0A0FF"
                });
              },
              error: function (request, status, error){
                console.log("code : " + request.status
                        + "\nmessage : " + request.responseText
                        + "\nerror : " + error);
              }
            });
          }
        }
        calendar.unselect()
      },
      eventClick: function(arg) {
        location.href = arg.event.url;
      },
      editable: true,
      dayMaxEvents: true, // allow "more" link when too many events

      // 일정 드래그 앤 드롭
      eventDragStart: function (event, jsEvent, ui, view) {
        draggedEventIsAllDay = event.allDay;
      },

      eventDrop: function (event, delta, reverFunc, jsEvent, ui, view) {
        // 주, 일 view일 때 종일 <-> 시간 변경 불가능하도록 설정
        if(view.type === 'agendaWeek' || view.type === 'agandaDay'){
          if(draggedEventIsAllDay !== event.allDay){
            alert('드래그 앤 드롭으로 종일 <-> 시간 간 변경은 불가능합니다.');
            location.reload();
            return false;
          }
        }

        // 수정된 날짜 반영
        let newDates = calDateWhenDragnDrop(event);

        // 드롭 일정 업데이트
        $.ajax({
          url: '',
          method: 'PUT'
        });
      },

      events: function(info, successCallback, failureCallback){
        $.ajax({
          url: '/calendar/schedule-list',
          method: 'GET',
          dataType: 'json',
          success: function(data) {
            let events = [];

            // 현재 시간
            let now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth();
            let day = now.getDate();
            let hours = now.getHours();
            let minutes = now.getMinutes();

            let today = new Date(year, month, day, hours, minutes);

            if(data != null){
              $.each(data, function(index, element) { // data의 요소 순회
                let calendarStartDate = new Date(element.calendarStartDate);
                let calendarEndDate = new Date(element.calendarEndDate);
                let isAllDay = element.isAllDay;
                let calendarColor = element.calendarColor;


                events.push({
                  title: element.calendarContent,
                  start: calendarStartDate,
                  end: calendarEndDate,
                  allDay: isAllDay,
                  url: "/calendar/schedule/"+element.id,
                  color: calendarColor
                });
              });
            }
            successCallback(events);
          },
          error: function (request, status, error){
            console.log("code : " + request.status
                    + "\nmessage : " + request.responseText
                    + "\nerror : " + error);
          }
        });
      },
    });

    calendar.render();
  });

  function calDateWhenDragnDrop(event) {
    // 드랍 시 수정된 날짜 반영하기
    let newDates = {
      startDate: '',
      endDate: ''
    }

    // 날짜와 시간이 모두 같은 경우
    if(!event.end){
      event.end = event.start;
    }

    // all day 하루
    if(event.allDay && event.end === event.start){
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
      newDates.endDate = newDates.startDate;
    }

    // all day 2일 이상
    else if (event.allDay && event.end !== null) {
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
      newDates.endDate = moment(event.end._d).subtract(1, 'days').format('YYYY-MM-DD');
    }

    //all day가 아님
    else if (!event.allDay) {
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD HH:mm');
      newDates.endDate = moment(event.end._d).format('YYYY-MM-DD HH:mm');
    }

    return newDates;
  }
</script>

<body>
  <section id="container">
    <header th:replace="/fragments/bodyHeader.html :: bodyHeader" />
    <aside th:replace="/fragments/bodySidebar.html :: bodySidebar(currentMenu='calendar')" />

    <!--main content start-->
    <section id="main-content">
      <section class="wrapper">
        <h3><i class="fa fa-angle-right"></i> Calendar</h3>
        <div class="row mt">
          <aside class="col-lg-3 mt">
            <h4><i class="fa fa-angle-right"></i> Draggable Events</h4>
            <div id="external-events">
              <div class="external-event label label-theme">My Event 1</div>
              <div class="external-event label label-success">My Event 2</div>
              <div class="external-event label label-info">My Event 3</div>
              <div class="external-event label label-warning">My Event 4</div>
              <div class="external-event label label-danger">My Event 5</div>
              <div class="external-event label label-default">My Event 6</div>
              <div class="external-event label label-theme">My Event 7</div>
              <div class="external-event label label-info">My Event 8</div>
              <div class="external-event label label-success">My Event 9</div>
              <p class="drop-after">
                <input type="checkbox" id="drop-remove"> Remove After Drop
              </p>
            </div>
          </aside>
          <aside class="col-lg-9 mt">
            <section class="panel">
              <div class="panel-body">
                <div id="calendar" class="has-toolbar"></div>
              </div>
            </section>
          </aside>
        </div>
      </section>
    </section>
    <!--main content end-->
    <footer th:replace="fragments/footer.html :: footer" />
  </section>

  <script src="/lib/jquery-ui-1.9.2.custom.min.js"></script>
  <script src="/lib/fullcalendar/fullcalendar.min.js"></script>
  <script src="/lib/fullcalendar/moment.min.js"></script>
<!--  <script src="/lib/calendar-conf-events.js"></script>-->

</body>
</html>
