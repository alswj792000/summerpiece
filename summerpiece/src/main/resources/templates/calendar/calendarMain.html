<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/fragments/header.html :: header"/>
<link href='/lib/fullcalendar/main.css' rel='stylesheet' />
<script src="/lib/fullcalendar/main.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let calendarEl = document.getElementById('calendar');
    let draggedEventIsAllDay ;

    let calendar = new FullCalendar.Calendar(calendarEl, {
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      initialDate: new Date(),
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectMirror: true,
      locale: 'ko',
      views: {
        month: {eventLimit : 5}
      },
      select: function(arg) {
        let calendarContent = prompt('일정 내용을 입력하세요.');
        if (calendarContent) {
          let calendarStart;
          let calendarEnd;
          let isAllDay = arg.allDay;
          console.log(isAllDay);

          if (isAllDay) {
            calendarStart = moment(arg.start).format('YYYY-MM-DD');
            calendarEnd = moment(arg.end).add(1, 'days').format('YYYY-MM-DD');

          } else {
            calendarStart = moment(arg.start._d).format('YYYY-MM-DD HH:mm');
            calendarEnd = moment(arg.end._d).format('YYYY-MM-DD HH:mm');
          }

          let data = {
            "calendarContent":calendarContent,
            "calendarStart":calendarStart,
            "calendarEnd":calendarEnd,
            "isAllDay":isAllDay
          }

          $.ajax({
            url: '/calendar/schedule',
            method: 'POST',
            data: data,
            dataType: 'text',
            beforeSend: function (jqXHR, settings) {
              let header = $("meta[name='_csrf_header']").attr("content");
              let token = $("meta[name='_csrf']").attr("content");
              jqXHR.setRequestHeader(header, token);
            },
            success: function(data){
              calendar.addEvent({
                title: calendarContent,
                start: calendarStart,
                end: calendarEnd,
                allDay: isAllDay
              });
            },
            error: function (request, status, error){
              console.log("code : " + request.status
                      + "\nmessage : " + request.responseText
                      + "\nerror : " + error);
            }
          });
        }
        calendar.unselect()
      },
      eventClick: function(arg) {
        if (confirm('Are you sure you want to delete this event?')) {
          arg.event.remove()
        }
      },
      editable: true,
      dayMaxEvents: true, // allow "more" link when too many events

      // 일정 드래그 앤 드롭
      eventDragStart: function (event, jsEvent, ui, view) {
        draggedEventIsAllDay = event.allDay;
      },

      eventDrop: function (event, delta, reverFunc, jsEvent, ui, view) {
        // 주, 일 view일 때 종일 <-> 시간 변경 불가능하도록 설정
        if(view.type === 'agendaWeek' || view.type === 'agandaDay'){
          if(draggedEventIsAllDay !== event.allDay){
            alert('드래그 앤 드롭으로 종일 <-> 시간 간 변경은 불가능합니다.');
            location.reload();
            return false;
          }
        }

        // 수정된 날짜 반영
        let newDates = calDateWhenDragnDrop(event);

        // 드롭 일정 업데이트
        $.ajax({
          url: '',
          method: 'PUT'
        });
      },

      events: function(info, successCallback, failureCallback){
        $.ajax({
          url: '/calendar/schedule',
          method: 'GET',
          dataType: 'json',
          success: function(data) {
            let events = [];

            // 현재 시간
            let now = new Date();
            let year = now.getFullYear();
            let month = now.getMonth();
            let day = now.getDate();
            let hours = now.getHours();
            let minutes = now.getMinutes();

            let today = new Date(year, month, day, hours, minutes);

            if(data != null){
              $.each(data, function(index, element) { // data의 요소 순회
                let calendarStartDate = new Date(element.calendarStartDate);
                let calendarEndDate = new Date(element.calendarEndDate);
                let calendarColor;

                if (today >= calendarEndDate){
                  calendarColor = "#d9534f";
                }
                else{
                  calendarColor = "#5bc0de";
                }

                events.push({
                  title: element.calendarContent,
                  start: calendarStartDate,
                  end: calendarEndDate,
                  url: "GET/calendar/schedule/"+element.id,
                  color: calendarColor
                });
              });
            }
            successCallback(events);
          },
          error: function (request, status, error){
            console.log("code : " + request.status
                    + "\nmessage : " + request.responseText
                    + "\nerror : " + error);
          }
        });
      },
    });

    calendar.render();
  });

  function calDateWhenDragnDrop(event) {
    // 드랍 시 수정된 날짜 반영하기
    let newDates = {
      startDate: '',
      endDate: ''
    }

    // 날짜와 시간이 모두 같은 경우
    if(!event.end){
      event.end = event.start;
    }

    // all day 하루
    if(event.allDay && event.end === event.start){
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
      newDates.endDate = newDates.startDate;
    }

    // all day 2일 이상
    else if (event.allDay && event.end !== null) {
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD');
      newDates.endDate = moment(event.end._d).subtract(1, 'days').format('YYYY-MM-DD');
    }

    //all day가 아님
    else if (!event.allDay) {
      newDates.startDate = moment(event.start._d).format('YYYY-MM-DD HH:mm');
      newDates.endDate = moment(event.end._d).format('YYYY-MM-DD HH:mm');
    }

    return newDates;
  }
</script>

<body>
  <section id="container">
    <header th:replace="/fragments/bodyHeader.html :: bodyHeader" />
    <aside th:replace="/fragments/bodySidebar.html :: bodySidebar(currentMenu='calendar')" />

    <!--main content start-->
    <section id="main-content">
      <section class="wrapper">
        <h3><i class="fa fa-angle-right"></i> Calendar</h3>
        <div class="row mt">
          <aside class="col-lg-3 mt">
            <h4><i class="fa fa-angle-right"></i> Draggable Events</h4>
            <div id="external-events">
              <div class="external-event label label-theme">My Event 1</div>
              <div class="external-event label label-success">My Event 2</div>
              <div class="external-event label label-info">My Event 3</div>
              <div class="external-event label label-warning">My Event 4</div>
              <div class="external-event label label-danger">My Event 5</div>
              <div class="external-event label label-default">My Event 6</div>
              <div class="external-event label label-theme">My Event 7</div>
              <div class="external-event label label-info">My Event 8</div>
              <div class="external-event label label-success">My Event 9</div>
              <p class="drop-after">
                <input type="checkbox" id="drop-remove"> Remove After Drop
              </p>
            </div>
          </aside>
          <aside class="col-lg-9 mt">
            <section class="panel">
              <div class="panel-body">
                <div id="calendar" class="has-toolbar"></div>
              </div>
            </section>
          </aside>
        </div>
      </section>
    </section>
    <!--main content end-->

    <!-- 일정 추가 MODAL -->
    <div class="modal fade" tabindex="-1" role="dialog" id="eventModal">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"></h4>
          </div>
          <div class="modal-body">

            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-allDay">하루종일</label>
                <input class='allDayNewEvent' id="edit-allDay" type="checkbox"></label>
              </div>
            </div>

            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-title">일정명</label>
                <input class="inputModal" type="text" name="edit-title" id="edit-title"
                       required="required" />
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-start">시작</label>
                <input class="inputModal" type="text" name="edit-start" id="edit-start" />
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-end">끝</label>
                <input class="inputModal" type="text" name="edit-end" id="edit-end" />
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-type">구분</label>
                <select class="inputModal" type="text" name="edit-type" id="edit-type">
                  <option value="카테고리1">카테고리1</option>
                  <option value="카테고리2">카테고리2</option>
                  <option value="카테고리3">카테고리3</option>
                  <option value="카테고리4">카테고리4</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-color">색상</label>
                <select class="inputModal" name="color" id="edit-color">
                  <option value="#D25565" style="color:#D25565;">빨간색</option>
                  <option value="#9775fa" style="color:#9775fa;">보라색</option>
                  <option value="#ffa94d" style="color:#ffa94d;">주황색</option>
                  <option value="#74c0fc" style="color:#74c0fc;">파란색</option>
                  <option value="#f06595" style="color:#f06595;">핑크색</option>
                  <option value="#63e6be" style="color:#63e6be;">연두색</option>
                  <option value="#a9e34b" style="color:#a9e34b;">초록색</option>
                  <option value="#4d638c" style="color:#4d638c;">남색</option>
                  <option value="#495057" style="color:#495057;">검정색</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-12">
                <label class="col-xs-4" for="edit-desc">설명</label>
                <textarea rows="4" cols="50" class="inputModal" name="edit-desc"
                          id="edit-desc"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer modalBtnContainer-addEvent">
            <button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" id="save-event">저장</button>
          </div>
          <div class="modal-footer modalBtnContainer-modifyEvent">
            <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
            <button type="button" class="btn btn-danger" id="deleteEvent">삭제</button>
            <button type="button" class="btn btn-primary" id="updateEvent">저장</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <footer th:replace="fragments/footer.html :: footer" />
  </section>

  <script src="/lib/jquery-ui-1.9.2.custom.min.js"></script>
  <script src="/lib/fullcalendar/fullcalendar.min.js"></script>
  <script src="/lib/fullcalendar/moment.min.js"></script>
<!--  <script src="/lib/calendar-conf-events.js"></script>-->

</body>
</html>
