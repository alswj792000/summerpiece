<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Dashboard">
    <meta name="keyword" content="Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
    <title>Reset Password</title>

    <!-- Favicons -->
    <link href="img/favicon.png" rel="icon">
    <link href="img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Bootstrap core CSS -->
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!--external css-->
    <link href="lib/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet">

    <!-- =======================================================
      Template Name: Dashio
      Template URL: https://templatemag.com/dashio-bootstrap-admin-template/
      Author: TemplateMag.com
      License: https://templatemag.com/license/
    ======================================================= -->
</head>

<body>

<div id="login-page">
    <div class="container">
        <form class="form-login">
            <h2 class="form-login-heading">Reset Your Password</h2>
            <div class="login-wrap">
                <div>
                    Enter your account's email address<br>
                    and we will send you a verification code to your email.
                </div>
                <br>
                <input type="text" class="form-control" name="email" placeholder="Email" autofocus><br>
                <button class="btn btn-theme btn-block" type="button" onclick="sendCode()">Send code</button><br>
                <input type="text" class="form-control" name="code" placeholder="Verification code"><br>
                <button class="btn btn-theme btn-block" type="button" onclick="verifyCode()">Verify code</button>

                <hr>

                <div>
                    Reset your password.
                </div>
                <br>
                <input type="password" class="form-control" name="newPwd" placeholder="Password"><br>
                <input type="password" class="form-control" name="confirmPwd" placeholder="Confirm password"><br>
                <button class="btn btn-theme btn-block" type="button" onclick="resetPwd()">Reset password</button>

                <hr>

                <div class="registration">
                    <label class="checkbox">
                    <span class="pull-right">
                        <a href="/login">Go back to log in?</a>
                    </span>
                    </label><br>
                </div>
            </div>
        </form>
    </div>
</div>
<!-- js placed at the end of the document so the pages load faster -->
<script src="lib/jquery/jquery.min.js"></script>
<script src="lib/bootstrap/js/bootstrap.min.js"></script>
<!--BACKSTRETCH-->
<!-- You can use an image of whatever size. This script will stretch to fit in any screen size.-->
<script type="text/javascript" src="lib/jquery.backstretch.min.js"></script>

<script>
    $.backstretch("img/login-bg.jpg", {
      speed: 500
    });

    var isCodeSent = false;
    var isCodeSame = false;
    var email;

    function sendCode() {
        isCodeSent = false;
        isCodeSame = false;

        email = document.getElementsByName("email")[0].value;

        var param = {
            "email": email
        }

        $.ajax({
            url: "/sendCode",
            type: "POST",
            data: JSON.stringify(param),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                if (data == '200') {
                    alertEmailSendResult(true);
                } else {
                    alertEmailSendResult(false);
                }
            },
            error: function(data) {
                alertEmailSendResult(false);
            }
        });
    }

    function alertEmailSendResult(result) {
        if (result) {
            alert('메일 발송에 성공하였습니다.');
        } else {
            alert('메일 발송에 실패하였습니다.');
        }

        isCodeSent = result;
    }

    function verifyCode() {
        if (!isCodeSent) {
            alert('이메일로 코드를 먼저 전송해주세요.');
            return;
        }

        isCodeSame = false;

        var code = document.getElementsByName("code")[0].value;

        var params = {
            "email": email,
            "code": code
        }

        $.ajax({
            url: "/verifyCode",
            type: "POST",
            data: JSON.stringify(params),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                if (data == '200') {
                    alert('코드가 일치합니다.');

                    isCodeSame = true;
                } else {
                    alert('시간이 경과되었거나, 코드가 일치하지 않습니다.');

                    isCodeSame = false;
                }
            },
            error: function(data) {
                isCodeSame = false;
            }
        });
    }

    function resetPwd() {
        if (!(isCodeSent && isCodeSame)) {
            alert('먼저 코드를 확인해주세요.');
            return;
        }

        var newPwd = document.getElementsByName("newPwd")[0].value;
        var confirmPwd = document.getElementsByName("confirmPwd")[0].value;

        if (newPwd != confirmPwd) {
            alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
            return;
        }

        var params = {
            "email": email,
            "newPwd": newPwd
        }

        $.ajax({
            url: "/resetPwd",
            type: "POST",
            data: JSON.stringify(params),
            contentType: "application/json; charset=utf-8",
            success: function(data) {
                location.href = "/login";
            },
            error: function(data) {

            }
        });
    }
  </script>
</body>

</html>
